<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Operaciones - Simulador de Trading</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .header h1 {
            color: #1e3c72;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .team-selector {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .team-selector h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .team-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .team-btn {
            padding: 15px 25px;
            border: 3px solid transparent;
            border-radius: 10px;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #333;
        }

        .team-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .team-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-buy {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .btn-buy:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-sell {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
        }

        .btn-sell:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-simulate {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            color: white;
            margin-top: 15px;
        }

        .btn-simulate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-clear {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
            margin-top: 10px;
        }

        .btn-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .summary {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #f59e0b;
            margin-top: 20px;
        }

        .summary h4 {
            color: #92400e;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
        }

        .summary-item span:first-child {
            font-weight: 600;
            color: #78350f;
        }

        .summary-item span:last-child {
            font-weight: 700;
            color: #92400e;
        }

        .operations-table {
            width: 100%;
            margin-top: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        table th {
            font-weight: 600;
            font-size: 0.95em;
        }

        table td {
            font-size: 0.9em;
        }

        table tbody tr:hover {
            background: #f8fafc;
        }

        .trade-sold {
            background: #f1f5f9;
            opacity: 0.7;
        }

        .op-buy {
            color: #10b981;
            font-weight: 600;
        }

        .op-sell {
            color: #ef4444;
            font-weight: 600;
        }

        .positive {
            color: #10b981;
            font-weight: 700;
        }

        .negative {
            color: #ef4444;
            font-weight: 700;
        }

        .neutral {
            color: #6b7280;
            font-weight: 600;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .simulator {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #3b82f6;
            margin-top: 20px;
        }

        .simulator h4 {
            color: #1e3a8a;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .simulation-results {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .sim-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .sim-card h5 {
            color: #1e3a8a;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .sim-card .value {
            font-size: 1.5em;
            font-weight: 700;
            color: #3b82f6;
        }

        .btn-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            padding: 12px 30px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .footer {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 30px;
        }

        .footer p {
            margin: 5px 0;
        }

        /* Modal Moderno */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-header h3 {
            color: #667eea;
            font-size: 1.5em;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8em;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #ef4444;
        }

        .modal-body {
            margin: 20px 0;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .modal-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-result {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .modal-result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }

        .modal-result-item:last-child {
            border-bottom: none;
        }

        .modal-result-item strong {
            color: #1e3a8a;
        }

        .btn-modal-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-modal-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-modal-secondary {
            background: #e5e7eb;
            color: #333;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-modal-secondary:hover {
            background: #d1d5db;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .simulation-results {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.6em;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.85em;
            }

            table th,
            table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Registro de Operaciones</h1>
            <p>Planifica tus compras y ventas, simula tus ganancias</p>
        </div>

        <div class="main-content">
            <!-- Formulario de Compra -->
            <div class="card">
                <h2>üìù Registrar Compra</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label>Iteraci√≥n</label>
                        <input type="number" id="iteration" min="1" max="35" value="1" placeholder="1-35">
                    </div>
                    <div class="form-group">
                        <label>Precio ASK (Compra mostrado en pantalla)</label>
                        <input type="number" id="price" min="0" step="0.01" placeholder="Precio con spread">
                    </div>
                </div>

                <div class="form-group">
                    <label>Cantidad a Invertir (Puntos)</label>
                    <input type="number" id="amount" min="0" step="0.01" placeholder="Cantidad">
                </div>

                <button type="button" class="btn btn-buy" onclick="addBuy()">
                    üí∞ Registrar Compra
                </button>
            </div>

            <!-- Resumen del Equipo -->
            <div class="card">
                <h2>üìä Resumen del Equipo</h2>
                
                <div class="summary-grid" style="background: white; padding: 0;">
                    <div class="summary-item">
                        <span>Balance Inicial:</span>
                        <span id="initialBalance">100.00 pts</span>
                    </div>
                    <div class="summary-item">
                        <span>Balance Actual:</span>
                        <span id="currentBalance">100.00 pts</span>
                    </div>
                    <div class="summary-item">
                        <span>Posici√≥n Total:</span>
                        <span id="totalPosition">0.00 unidades</span>
                    </div>
                    <div class="summary-item">
                        <span>Posiciones Abiertas:</span>
                        <span id="openPositions">0</span>
                    </div>
                </div>

                <button type="button" class="btn btn-sell" onclick="openSellAllModal()" style="margin-top: 20px; width: 100%;">
                    üíµ Vender Todas las Posiciones
                </button>

                <button type="button" class="btn btn-simulate" onclick="openSimulateAllModal()" style="margin-top: 10px; width: 100%; background: #3b82f6; color: white;">
                    üîÆ Simular Todas las Posiciones
                </button>

                <button type="button" class="btn btn-clear" onclick="clearAllData()" style="margin-top: 10px; width: 100%;">
                    üóëÔ∏è Limpiar Todos los Datos
                </button>
            </div>
        </div>

        <!-- Tabla de Historial de Posiciones -->
        <div class="card">
            <h2>üìã Historial de Posiciones</h2>
            <div class="operations-table">
                <table id="operationsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Iter. Compra</th>
                            <th>Precio Compra</th>
                            <th>Invertido</th>
                            <th>Unidades</th>
                            <th>Iter. Venta</th>
                            <th>Precio Venta</th>
                            <th>Ganancia</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="operationsBody">
                        <tr>
                            <td colspan="10" style="text-align: center; color: #999; padding: 30px;">
                                No hay operaciones registradas a√∫n
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="footer">
            <p>¬© 2025 Eder Zu√±iga Mu√±oz</p>
            <p>Apoyado en GitHub Copilot</p>
        </div>
    </div>

    <!-- Modal para Vender Posici√≥n Individual -->
    <div id="sellModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üíµ Vender Posici√≥n</h3>
                <button class="modal-close" onclick="closeModal('sellModal')">&times;</button>
            </div>
            <div class="modal-body">
                <label>Iteraci√≥n de Venta</label>
                <input type="number" id="sellIteration" class="modal-input" min="1" max="35" placeholder="1-35">
                
                <label>Precio BID (Venta mostrado en pantalla)</label>
                <input type="number" id="sellPrice" class="modal-input" min="0" step="0.01" placeholder="Precio con spread">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-secondary" onclick="closeModal('sellModal')">Cancelar</button>
                <button type="button" class="btn-modal-primary" onclick="confirmSell()">Confirmar Venta</button>
            </div>
        </div>
    </div>

    <!-- Modal para Simular Posici√≥n Individual -->
    <div id="simulateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîÆ Simular Venta</h3>
                <button class="modal-close" onclick="closeModal('simulateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <label>Precio BID Futuro</label>
                <input type="number" id="simPrice" class="modal-input" min="0" step="0.01" placeholder="Ej: 120.00">
                
                <div id="simulationResult" class="modal-result" style="display: none;">
                    <div class="modal-result-item">
                        <span>Invertido:</span>
                        <strong id="simInvested">---</strong>
                    </div>
                    <div class="modal-result-item">
                        <span>Valor Venta:</span>
                        <strong id="simProceeds">---</strong>
                    </div>
                    <div class="modal-result-item">
                        <span>Ganancia:</span>
                        <strong id="simProfit">---</strong>
                    </div>
                    <div class="modal-result-item">
                        <span>Rendimiento:</span>
                        <strong id="simReturn">---</strong>
                    </div>
                    <div class="modal-result-item">
                        <span>Balance Despu√©s:</span>
                        <strong id="simFinalBalance">---</strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-secondary" onclick="closeModal('simulateModal')">Cerrar</button>
                <button type="button" class="btn-modal-primary" onclick="runIndividualSimulation()">Calcular</button>
            </div>
        </div>
    </div>

    <!-- Modal para Vender Todas las Posiciones -->
    <div id="sellAllModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üíµ Vender Todas las Posiciones</h3>
                <button class="modal-close" onclick="closeModal('sellAllModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong id="sellAllCount">0</strong> posiciones abiertas ser√°n vendidas.</p>
                
                <label>Iteraci√≥n de Venta</label>
                <input type="number" id="sellAllIteration" class="modal-input" min="1" max="35" placeholder="1-35">
                
                <label>Precio BID (Venta mostrado en pantalla)</label>
                <input type="number" id="sellAllPrice" class="modal-input" min="0" step="0.01" placeholder="Precio con spread">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-secondary" onclick="closeModal('sellAllModal')">Cancelar</button>
                <button type="button" class="btn-modal-primary" onclick="confirmSellAll()">Vender Todo</button>
            </div>
        </div>
    </div>

    <!-- Modal para Simular Venta Masiva -->
    <div id="simulateAllModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîÆ Simular Venta Masiva</h3>
                <button class="modal-close" onclick="closeModal('simulateAllModal')">&times;</button>
            </div>
            <div class="modal-body">
                <label>Precio BID Futuro</label>
                <input type="number" id="simAllPrice" class="modal-input" min="0" step="0.01" placeholder="Ej: 120.00">
                <div id="simulationAllResult" class="modal-result" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-secondary" onclick="closeModal('simulateAllModal')">Cerrar</button>
                <button type="button" class="btn-modal-primary" onclick="runSimulateAll()">Calcular</button>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="resultTitle">‚úÖ Resultado</h3>
                <button class="modal-close" onclick="closeModal('resultModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="resultContent" class="modal-result"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-primary" onclick="closeModal('resultModal')">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n (similar a trading-chart.html)
        let teamData = { 
            balance: 100, 
            position: 0, 
            pendingSell: [] // Array de posiciones abiertas
        };

        let currentPositionId = null; // Para manejar modales

        // Funciones de Modal
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Limpiar inputs
            if (modalId === 'sellModal') {
                document.getElementById('sellIteration').value = '';
                document.getElementById('sellPrice').value = '';
            } else if (modalId === 'simulateModal') {
                document.getElementById('simPrice').value = '';
                document.getElementById('simulationResult').style.display = 'none';
            } else if (modalId === 'sellAllModal') {
                document.getElementById('sellAllIteration').value = '';
                document.getElementById('sellAllPrice').value = '';
            } else if (modalId === 'simulateAllModal') {
                document.getElementById('simAllPrice').value = '';
                document.getElementById('simulationAllResult').style.display = 'none';
            }
        }

        // Cerrar modal al hacer clic fuera del contenido
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };

        // Cargar datos del localStorage al iniciar
        function loadData() {
            const saved = localStorage.getItem('registroOperaciones');
            if (saved) {
                teamData = JSON.parse(saved);
            }
            updateDisplay();
        }

        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('registroOperaciones', JSON.stringify(teamData));
        }

        // Registrar compra
        function addBuy() {
            const iteration = parseInt(document.getElementById('iteration').value);
            const price = parseFloat(document.getElementById('price').value);
            const amount = parseFloat(document.getElementById('amount').value);
            
            // Validaciones
            if (!iteration || iteration < 1 || iteration > 35) {
                alert('Por favor ingresa una iteraci√≥n v√°lida (1-35)');
                return;
            }
            
            if (!price || price <= 0) {
                alert('Por favor ingresa un precio v√°lido');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Por favor ingresa una cantidad v√°lida');
                return;
            }
            
            // Validar balance suficiente
            if (amount > teamData.balance) {
                alert(`Balance insuficiente. Tienes ${teamData.balance.toFixed(2)} pts disponibles`);
                return;
            }
            
            // Calcular unidades adquiridas
            const unitsAcquired = amount / price;
            
            // Actualizar balance y posici√≥n
            teamData.balance -= amount;
            teamData.position += unitsAcquired;
            
            // Registrar posici√≥n abierta
            teamData.pendingSell.push({
                id: Date.now() + Math.random(),
                buyIteration: iteration,
                buyPrice: price,
                invested: amount,
                units: unitsAcquired,
                sold: false,
                sellIteration: null,
                sellPrice: null,
                profit: null
            });
            
            // Guardar y actualizar
            saveData();
            updateDisplay();
            clearForm();
            
            alert('‚úÖ Compra registrada exitosamente');
        }

        // Vender posici√≥n individual
        function sellPosition(id) {
            const position = teamData.pendingSell.find(p => p.id === id);
            if (!position || position.sold) return;
            
            currentPositionId = id;
            openModal('sellModal');
        }

        // Confirmar venta desde modal
        function confirmSell() {
            const iteration = parseInt(document.getElementById('sellIteration').value);
            const sellPrice = parseFloat(document.getElementById('sellPrice').value);

            // Validaciones
            if (isNaN(iteration) || iteration < 1 || iteration > 35) {
                showResult('‚ö†Ô∏è Error', 'La iteraci√≥n debe ser entre 1 y 35');
                return;
            }

            if (isNaN(sellPrice) || sellPrice <= 0) {
                showResult('‚ö†Ô∏è Error', 'El precio debe ser un n√∫mero mayor a 0');
                return;
            }

            const position = teamData.pendingSell.find(p => p.id === currentPositionId);
            if (!position || position.sold) {
                closeModal('sellModal');
                return;
            }

            if (iteration <= position.buyIteration) {
                showResult('‚ö†Ô∏è Error', 'La iteraci√≥n de venta debe ser posterior a la de compra');
                return;
            }

            // Calcular ganancia
            const proceeds = position.units * sellPrice;
            const profit = proceeds - position.invested;
            
            // Actualizar posici√≥n
            position.sold = true;
            position.sellIteration = iteration;
            position.sellPrice = sellPrice;
            position.profit = profit;
            
            // Actualizar balance y posici√≥n total
            teamData.balance += proceeds;
            teamData.position -= position.units;
            
            saveData();
            updateDisplay();
            closeModal('sellModal');
            
            showResult('‚úÖ Venta Exitosa', `
                <div style="text-align: left;">
                    <p><strong>Valor de venta:</strong> ${proceeds.toFixed(2)} pts</p>
                    <p><strong>Ganancia:</strong> <span style="color: ${profit >= 0 ? '#10b981' : '#ef4444'}">${profit >= 0 ? '+' : ''}${profit.toFixed(2)} pts</span></p>
                    <p><strong>Balance actual:</strong> ${teamData.balance.toFixed(2)} pts</p>
                </div>
            `);
        }

        // Simular venta individual
        function simulateSell(id) {
            const position = teamData.pendingSell.find(p => p.id === id);
            if (!position || position.sold) return;
            
            currentPositionId = id;
            openModal('simulateModal');
        }

        // Ejecutar simulaci√≥n individual
        function runIndividualSimulation() {
            const position = teamData.pendingSell.find(p => p.id === currentPositionId);
            if (!position) return;

            const simPrice = parseFloat(document.getElementById('simPrice').value);
            
            if (isNaN(simPrice) || simPrice <= 0) {
                showResult('‚ö†Ô∏è Error', 'El precio debe ser un n√∫mero mayor a 0');
                return;
            }
            
            const proceeds = position.units * simPrice;
            const profit = proceeds - position.invested;
            const profitPercent = (profit / position.invested) * 100;
            const finalBalance = teamData.balance + proceeds;
            
            // Mostrar resultados en el modal
            const resultDiv = document.getElementById('simulationResult');
            resultDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 12px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: #1e40af;">ÔøΩ Resultados de la Simulaci√≥n</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="font-weight: 600; color: #475569;">Invertido:</span>
                            <span style="color: #1e293b;">${position.invested.toFixed(2)} pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="font-weight: 600; color: #475569;">Valor de venta:</span>
                            <span style="color: #1e293b;">${proceeds.toFixed(2)} pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="font-weight: 600; color: #475569;">Ganancia:</span>
                            <span style="font-weight: 700; color: ${profit >= 0 ? '#10b981' : '#ef4444'};">${profit >= 0 ? '+' : ''}${profit.toFixed(2)} pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="font-weight: 600; color: #475569;">Rendimiento:</span>
                            <span style="font-weight: 700; color: ${profit >= 0 ? '#10b981' : '#ef4444'};">${profit >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px; margin-top: 5px;">
                            <span style="font-weight: 700; color: white;">Balance final:</span>
                            <span style="font-weight: 700; color: white;">${finalBalance.toFixed(2)} pts</span>
                        </div>
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';
        }

        // Vender todas las posiciones abiertas
        function openSellAllModal() {
            const openPositions = teamData.pendingSell.filter(p => !p.sold);
            
            if (openPositions.length === 0) {
                showResult('‚ö†Ô∏è Sin Posiciones', 'No tienes posiciones abiertas para vender');
                return;
            }
            
            document.getElementById('sellAllCount').textContent = openPositions.length;
            openModal('sellAllModal');
        }

        // Confirmar venta de todas las posiciones
        function confirmSellAll() {
            const iteration = parseInt(document.getElementById('sellAllIteration').value);
            const sellPrice = parseFloat(document.getElementById('sellAllPrice').value);

            // Validaciones
            if (isNaN(iteration) || iteration < 1 || iteration > 35) {
                showResult('‚ö†Ô∏è Error', 'La iteraci√≥n debe ser entre 1 y 35');
                return;
            }

            if (isNaN(sellPrice) || sellPrice <= 0) {
                showResult('‚ö†Ô∏è Error', 'El precio debe ser un n√∫mero mayor a 0');
                return;
            }

            const openPositions = teamData.pendingSell.filter(p => !p.sold);
            
            let totalProfit = 0;
            let totalProceeds = 0;
            
            // Vender todas
            openPositions.forEach(position => {
                const proceeds = position.units * sellPrice;
                const profit = proceeds - position.invested;
                
                position.sold = true;
                position.sellIteration = iteration;
                position.sellPrice = sellPrice;
                position.profit = profit;
                
                totalProceeds += proceeds;
                totalProfit += profit;
                
                teamData.balance += proceeds;
                teamData.position -= position.units;
            });
            
            saveData();
            updateDisplay();
            closeModal('sellAllModal');
            
            showResult('‚úÖ Venta Masiva Exitosa', `
                <div style="text-align: left;">
                    <p><strong>Posiciones vendidas:</strong> ${openPositions.length}</p>
                    <p><strong>Ganancia total:</strong> <span style="color: ${totalProfit >= 0 ? '#10b981' : '#ef4444'}">${totalProfit >= 0 ? '+' : ''}${totalProfit.toFixed(2)} pts</span></p>
                    <p><strong>Balance final:</strong> ${teamData.balance.toFixed(2)} pts</p>
                </div>
            `);
        }

        // Simular venta masiva
        function openSimulateAllModal() {
            const openPositions = teamData.pendingSell.filter(p => !p.sold);
            if (openPositions.length === 0) {
                showResult('‚ö†Ô∏è Sin Posiciones', 'No tienes posiciones abiertas para simular');
                return;
            }
            document.getElementById('simAllPrice').value = '';
            document.getElementById('simulationAllResult').style.display = 'none';
            openModal('simulateAllModal');
        }

        function runSimulateAll() {
            const simPrice = parseFloat(document.getElementById('simAllPrice').value);
            const openPositions = teamData.pendingSell.filter(p => !p.sold);
            if (isNaN(simPrice) || simPrice <= 0) {
                showResult('‚ö†Ô∏è Error', 'El precio debe ser un n√∫mero mayor a 0');
                return;
            }
            if (openPositions.length === 0) {
                showResult('‚ö†Ô∏è Sin Posiciones', 'No tienes posiciones abiertas para simular');
                return;
            }
            let totalProceeds = 0;
            let totalInvested = 0;
            openPositions.forEach(position => {
                totalProceeds += position.units * simPrice;
                totalInvested += position.invested;
            });
            const finalBalance = teamData.balance + totalProceeds;
            const totalProfit = totalProceeds - totalInvested;
            const returnPercent = (totalProfit / totalInvested) * 100;
            const resultDiv = document.getElementById('simulationAllResult');
            resultDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 12px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: #1e40af;">üìä Resultados de la Simulaci√≥n Masiva</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="font-weight: 600; color: #475569;">Invertido Total:</span>
                            <span style="color: #1e293b;">${totalInvested.toFixed(2)} pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="font-weight: 600; color: #475569;">Valor de venta total:</span>
                            <span style="color: #1e293b;">${totalProceeds.toFixed(2)} pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="font-weight: 600; color: #475569;">Ganancia total:</span>
                            <span style="font-weight: 700; color: ${totalProfit >= 0 ? '#10b981' : '#ef4444'};">${totalProfit >= 0 ? '+' : ''}${totalProfit.toFixed(2)} pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px;">
                            <span style="font-weight: 600; color: #475569;">Rendimiento total:</span>
                            <span style="font-weight: 700; color: ${totalProfit >= 0 ? '#10b981' : '#ef4444'};">${totalProfit >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px; margin-top: 5px;">
                            <span style="font-weight: 700; color: white;">Balance final:</span>
                            <span style="font-weight: 700; color: white;">${finalBalance.toFixed(2)} pts</span>
                        </div>
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';
        }

        // Mostrar resultado en modal
        function showResult(title, content) {
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultContent').innerHTML = content;
            openModal('resultModal');
        }

        // Limpiar formulario
        function clearForm() {
            document.getElementById('iteration').value = '';
            document.getElementById('price').value = '';
            document.getElementById('amount').value = '';
        }

        // Eliminar posici√≥n
        function deletePosition(id) {
            const index = teamData.pendingSell.findIndex(p => p.id === id);
            
            if (index !== -1) {
                const position = teamData.pendingSell[index];
                
                // No permitir eliminar posiciones vendidas
                if (position.sold) {
                    showResult('‚ö†Ô∏è Acci√≥n No Permitida', 'No puedes eliminar una posici√≥n que ya fue vendida. Solo puedes eliminar posiciones abiertas.');
                    return;
                }
                
                if (!confirm('¬øEst√°s seguro de eliminar esta posici√≥n? Esto recalcular√° el balance.')) {
                    return;
                }
                
                // Devolver el dinero invertido
                teamData.balance += position.invested;
                teamData.position -= position.units;
                
                teamData.pendingSell.splice(index, 1);
                
                saveData();
                updateDisplay();
            }
        }

        // Actualizar visualizaci√≥n
        function updateDisplay() {
            const openPositions = teamData.pendingSell.filter(p => !p.sold).length;
            
            // Actualizar resumen
            document.getElementById('initialBalance').textContent = '100.00 pts';
            document.getElementById('currentBalance').textContent = teamData.balance.toFixed(2) + ' pts';
            document.getElementById('totalPosition').textContent = teamData.position.toFixed(2) + ' unidades';
            document.getElementById('openPositions').textContent = openPositions;
            
            // Actualizar tabla
            const tbody = document.getElementById('operationsBody');
            
            if (teamData.pendingSell.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; color: #999; padding: 30px;">
                            No hay operaciones registradas a√∫n
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = teamData.pendingSell.map((pos, index) => {
                    const rowClass = pos.sold ? 'trade-sold' : '';
                    let statusBadge, sellIterText, sellPriceText, profitText, actionButtons;
                    
                    if (pos.sold) {
                        const profitClass = pos.profit >= 0 ? 'positive' : 'negative';
                        statusBadge = `<span class="op-sell">VENDIDA</span>`;
                        sellIterText = `#${pos.sellIteration}`;
                        sellPriceText = `${pos.sellPrice.toFixed(2)} pts`;
                        profitText = `<span class="${profitClass}">${pos.profit >= 0 ? '+' : ''}${pos.profit.toFixed(2)} pts</span>`;
                        actionButtons = `
                            <button type="button" class="delete-btn" disabled style="background: #9ca3af; cursor: not-allowed; opacity: 0.5;">
                                ÔøΩ Vendida
                            </button>
                        `;
                    } else {
                        statusBadge = `<span class="op-buy">ABIERTA</span>`;
                        sellIterText = '-';
                        sellPriceText = '-';
                        profitText = '-';
                        actionButtons = `
                            <button type="button" class="delete-btn" onclick="simulateSell(${pos.id})" style="background: #3b82f6; margin-bottom: 5px;">
                                üîÆ Simular
                            </button>
                            <button type="button" class="delete-btn" onclick="sellPosition(${pos.id})" style="background: #10b981; margin-bottom: 5px;">
                                üíµ Vender
                            </button>
                            <button type="button" class="delete-btn" onclick="deletePosition(${pos.id})">
                                üóëÔ∏è Eliminar
                            </button>
                        `;
                    }
                    
                    return `
                        <tr class="${rowClass}">
                            <td><strong>${index + 1}</strong></td>
                            <td>#${pos.buyIteration}</td>
                            <td>${pos.buyPrice.toFixed(2)} pts</td>
                            <td>${pos.invested.toFixed(2)} pts</td>
                            <td>${pos.units.toFixed(2)}</td>
                            <td>${sellIterText}</td>
                            <td>${sellPriceText}</td>
                            <td>${profitText}</td>
                            <td>${statusBadge}</td>
                            <td style="min-width: 120px;">
                                ${actionButtons}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Limpiar todos los datos
        function clearAllData() {
            if (!confirm('¬øEst√°s seguro de eliminar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            teamData = { balance: 100, position: 0, pendingSell: [] };
            
            localStorage.removeItem('registroOperaciones');
            updateDisplay();
            
            showResult('‚úÖ Datos Eliminados', 'Todos los datos han sido eliminados y el balance ha sido reiniciado');
        }

        // Inicializar al cargar la p√°gina
        window.onload = function() {
            loadData();
        };
    </script>
</body>
</html>
