<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Chart - Velas Japonesas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Panel de equipos */
        .teams-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .teams-panel h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .btn-reset {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 0.9em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-reset:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-export {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 0.9em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-export:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-help {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 0.9em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-help:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .teams-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .team-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 20px;
            border: 3px solid #ddd;
        }

        .team-card.team-a {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        .team-card.team-b {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }

        .team-card.team-c {
            border-color: #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }

        .team-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #1e3c72;
        }

        .team-balance {
            font-size: 1.2em;
            font-weight: bold;
        }

        .team-card.team-a .team-balance { color: #dc2626; }
        .team-card.team-b .team-balance { color: #2563eb; }
        .team-card.team-c .team-balance { color: #059669; }

        .team-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.9em;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .form-group input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-buy {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 5px;
        }

        .btn-buy:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-buy:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .team-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .info-item {
            font-size: 0.85em;
            color: #666;
        }

        .info-item strong {
            color: #333;
            font-size: 1.1em;
        }

        .btn-history {
            width: 100%;
            margin-top: 10px;
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 0.85em;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-history:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }

        /* Modal de historial */
        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .history-modal.show {
            display: flex;
        }

        .history-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #e5e7eb;
        }

        .history-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #1e3c72;
        }

        .btn-close-history {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 0.9em;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-close-history:hover {
            background: #dc2626;
        }

        .history-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f3f4f6;
            border-radius: 10px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #1e3c72;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th {
            background: #1e3c72;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-size: 0.9em;
        }

        .history-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.85em;
        }

        .history-table tr:hover {
            background: #f9fafb;
        }

        .trade-buy {
            color: #10b981;
            font-weight: 600;
        }

        .trade-sell {
            color: #ef4444;
            font-weight: 600;
        }

        .btn-sell-trade {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 12px;
            font-size: 0.8em;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-sell-trade:hover {
            background: #dc2626;
        }

        .btn-sell-trade:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-sell-all {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.95em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            width: 100%;
        }

        .btn-sell-all:hover {
            background: #d97706;
        }

        .btn-sell-all:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .trade-sold {
            background: #fee2e2 !important;
            opacity: 0.6;
        }

        .no-trades {
            text-align: center;
            padding: 30px;
            color: #666;
            font-style: italic;
        }

        .header {
            background: white;
            border-radius: 15px 15px 0 0;
            padding: 25px 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            flex: 1;
        }

        .header-title {
            font-size: 2em;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .header-subtitle {
            color: #666;
            font-size: 0.95em;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* Temporizador */
        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .timer-label {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .timer-display {
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            font-family: 'Courier New', monospace;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .timer-display.warning {
            color: #fbbf24;
            animation: pulse 1s infinite;
        }

        .timer-display.danger {
            color: #ef4444;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .iteration-info {
            text-align: right;
        }

        .iteration-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 3px;
        }

        .iteration-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #1e3c72;
        }

        .btn-next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-next:active {
            transform: translateY(0);
        }

        .btn-next:disabled {
            background: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .chart-container {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .price-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            gap: 10px;
        }

        /* Contenedor para ambas secciones de precios */
        .prices-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .price-section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .price-section-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #666;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .price-info-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .price-info-row.single {
            grid-template-columns: 1fr;
        }

        .price-item {
            text-align: center;
            flex: 1;
        }

        .price-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .price-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .price-value.open { color: #6366f1; }
        .price-value.high { color: #10b981; }
        .price-value.low { color: #ef4444; }
        .price-value.close { color: #f59e0b; }
        .price-value.buy { color: #10b981; }
        .price-value.sell { color: #ef4444; }

        .chart-wrapper {
            position: relative;
            height: 500px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .status-message {
            text-align: center;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Modal / Ventana emergente */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideIn 0.3s ease;
            position: relative;
        }

        .modal-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .modal-message {
            font-size: 1.2em;
            color: #666;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .modal-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Podio de ganadores */
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin: 30px 0;
            height: 300px;
        }

        .podium-place {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            animation: podiumRise 0.6s ease forwards;
        }

        .podium-place.first {
            order: 2;
            animation-delay: 0.3s;
        }

        .podium-place.second {
            order: 1;
            animation-delay: 0.1s;
        }

        .podium-place.third {
            order: 3;
            animation-delay: 0.2s;
        }

        .podium-block {
            width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .podium-block:hover {
            transform: scale(1.05);
        }

        .podium-place.first .podium-block {
            height: 200px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }

        .podium-place.second .podium-block {
            height: 150px;
            background: linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 100%);
        }

        .podium-place.third .podium-block {
            height: 100px;
            background: linear-gradient(135deg, #CD7F32 0%, #B8860B 100%);
        }

        .podium-medal {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .podium-team-name {
            font-weight: bold;
            font-size: 1.1em;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            margin-bottom: 5px;
        }

        .podium-balance {
            font-size: 1.3em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            margin: 10px 0;
        }

        .podium-position {
            font-size: 2em;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 10px;
        }

        @keyframes podiumRise {
            from {
                transform: translateY(300px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Secci√≥n de Etapa y Evento */
        .stage-event-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stage-box, .event-box {
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stage-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .stage-label {
            font-size: 0.8em;
            opacity: 0.9;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stage-name {
            font-size: 1.3em;
            font-weight: bold;
        }

        .event-box {
            background: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .event-box.positive {
            border-left: 5px solid #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
        }

        .event-box.negative {
            border-left: 5px solid #ef4444;
            background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
        }

        .event-box.neutral {
            border-left: 5px solid #6b7280;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        .event-icon {
            font-size: 2.5em;
            line-height: 1;
        }

        .event-content {
            flex: 1;
        }

        .event-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .event-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 3px;
        }

        .event-impact {
            font-size: 1em;
            font-weight: 600;
        }

        .event-impact.positive {
            color: #10b981;
        }

        .event-impact.negative {
            color: #ef4444;
        }

        .event-impact.neutral {
            color: #6b7280;
        }

        @media (max-width: 768px) {
            .teams-container {
                grid-template-columns: 1fr;
            }

            .teams-panel h2 {
                flex-direction: column;
                gap: 10px;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-right {
                flex-direction: column;
                width: 100%;
            }

            .timer-container {
                width: 100%;
            }

            .iteration-info {
                text-align: center;
            }

            .btn-next {
                width: 100%;
            }

            /* Apilar secciones de precios verticalmente en m√≥vil */
            .prices-wrapper {
                grid-template-columns: 1fr;
            }

            .stage-event-container {
                grid-template-columns: 1fr;
            }

            .price-info {
                flex-wrap: wrap;
                gap: 15px;
            }

            .price-item {
                flex: 1 1 30%;
                min-width: 100px;
            }
        }

        /* Footer */
        .footer {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            border-radius: 10px;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);
        }

        .footer p {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .footer .copyright {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .footer .powered-by {
            font-size: 0.85em;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Panel de Equipos -->
        <div class="teams-panel">
            <h2>
                üíº Panel de Trading - Equipos
                <button class="btn-help" onclick="window.open('ayuda.html', '_blank')" title="Ayuda e instrucciones">‚ùì Ayuda</button>
                <button class="btn-reset" onclick="resetTeamsData()" title="Reiniciar equipos">üîÑ Reset</button>
                <button class="btn-export" onclick="exportTeamsData()" title="Exportar datos">üì• Exportar</button>
            </h2>
            <div class="teams-container">
                <!-- Equipo A -->
                <div class="team-card team-a">
                    <div class="team-header">
                        <span class="team-name">üî¥ Equipo A</span>
                        <span class="team-balance" id="balance-a">100 ptos</span>
                    </div>
                    <div class="team-form">
                        <div class="form-group">
                            <label>Cantidad a Comprar (puntos)</label>
                            <input type="number" id="amount-a" min="0" step="1" placeholder="0">
                        </div>
                        <button class="btn-buy" onclick="buyForTeam('a')">üõí Comprar</button>
                    </div>
                    <div class="team-info">
                        <div class="info-item">Posici√≥n: <strong id="position-a">0 ptos</strong></div>
                        <div class="info-item">Operaciones: <strong id="trades-a">0</strong></div>
                    </div>
                    <button class="btn-history" onclick="showHistory('a')">üìã Ver Historial</button>
                </div>

                <!-- Equipo B -->
                <div class="team-card team-b">
                    <div class="team-header">
                        <span class="team-name">üîµ Equipo B</span>
                        <span class="team-balance" id="balance-b">100 ptos</span>
                    </div>
                    <div class="team-form">
                        <div class="form-group">
                            <label>Cantidad a Comprar (puntos)</label>
                            <input type="number" id="amount-b" min="0" step="1" placeholder="0">
                        </div>
                        <button class="btn-buy" onclick="buyForTeam('b')">üõí Comprar</button>
                    </div>
                    <div class="team-info">
                        <div class="info-item">Posici√≥n: <strong id="position-b">0 ptos</strong></div>
                        <div class="info-item">Operaciones: <strong id="trades-b">0</strong></div>
                    </div>
                    <button class="btn-history" onclick="showHistory('b')">üìã Ver Historial</button>
                </div>

                <!-- Equipo C -->
                <div class="team-card team-c">
                    <div class="team-header">
                        <span class="team-name">üü¢ Equipo C</span>
                        <span class="team-balance" id="balance-c">100 ptos</span>
                    </div>
                    <div class="team-form">
                        <div class="form-group">
                            <label>Cantidad a Comprar (puntos)</label>
                            <input type="number" id="amount-c" min="0" step="1" placeholder="0">
                        </div>
                        <button class="btn-buy" onclick="buyForTeam('c')">üõí Comprar</button>
                    </div>
                    <div class="team-info">
                        <div class="info-item">Posici√≥n: <strong id="position-c">0 ptos</strong></div>
                        <div class="info-item">Operaciones: <strong id="trades-c">0</strong></div>
                    </div>
                    <button class="btn-history" onclick="showHistory('c')">üìã Ver Historial</button>
                </div>
            </div>
        </div>

        <div class="header">
            <div class="header-left">
                <h1 class="header-title">üìà Trading Chart</h1>
                <p class="header-subtitle">An√°lisis de velas japonesas en tiempo real para la Sincro de Commercial Support</p>
            </div>
            <div class="header-right">
                <div class="timer-container">
                    <div class="timer-label">‚è±Ô∏è Tiempo</div>
                    <div class="timer-display" id="timer-display">30</div>
                </div>
                <div class="iteration-info">
                    <div class="iteration-label">Iteraci√≥n</div>
                    <div class="iteration-number"><span id="current-iteration">0</span> / <span id="total-iterations">0</span></div>
                </div>
                <button id="btn-next" class="btn-next">Siguiente ‚ñ∂</button>
            </div>
        </div>

        <div class="chart-container">
            <div id="loading" class="loading">Cargando datos...</div>
            
            <div id="chart-content" style="display: none;">
                <!-- Secci√≥n de Etapa y Evento Actual -->
                <div class="stage-event-container" id="stage-event-info" style="display: none;">
                    <div class="stage-box">
                        <div class="stage-label">Etapa Actual</div>
                        <div class="stage-name" id="current-stage">üìã Planificaci√≥n/An√°lisis</div>
                    </div>
                    <div class="event-box" id="event-box">
                        <div class="event-icon" id="event-icon">üé≤</div>
                        <div class="event-content">
                            <div class="event-label">‚ö° Pr√≥ximo Evento (Afectar√° siguiente iteraci√≥n)</div>
                            <div class="event-name" id="event-name">Esperando pr√≥xima iteraci√≥n...</div>
                            <div class="event-desc" id="event-desc" style="font-size: 0.85em; color: #666; margin-top: 3px; font-style: italic;"></div>
                            <div class="event-impact" id="event-impact"></div>
                        </div>
                    </div>
                </div>

                <!-- Contenedor de las dos secciones -->
                <div class="prices-wrapper">
                    <!-- Secci√≥n OHLC -->
                    <div class="price-section">
                        <div class="price-section-title">üìä Datos de la Vela</div>
                        <div class="price-info-row">
                            <div class="price-item">
                                <div class="price-label">Apertura</div>
                                <div class="price-value open" id="price-open">0 ptos</div>
                            </div>
                            <div class="price-item">
                                <div class="price-label">M√°ximo</div>
                                <div class="price-value high" id="price-high">0 ptos</div>
                            </div>
                            <div class="price-item">
                                <div class="price-label">M√≠nimo</div>
                                <div class="price-value low" id="price-low">0 ptos</div>
                            </div>
                            <div class="price-item">
                                <div class="price-label">Cierre</div>
                                <div class="price-value close" id="price-close">0 ptos</div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n Compra/Venta -->
                    <div class="price-section">
                        <div class="price-section-title">üí± Precios de Operaci√≥n</div>
                        <div class="price-info-row">
                            <div class="price-item">
                                <div class="price-label">üü¢ Compra (ASK)</div>
                                <div class="price-value buy" id="price-buy">0 ptos</div>
                            </div>
                            <div class="price-item">
                                <div class="price-label">üî¥ Venta (BID)</div>
                                <div class="price-value sell" id="price-sell">0 ptos</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <canvas id="chart"></canvas>
                </div>

                <div id="status-message" class="status-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal / Ventana emergente -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon" id="modal-icon">üí°</div>
            <h2 class="modal-title" id="modal-title">Iteraci√≥n 5</h2>
            <p class="modal-message" id="modal-message">Mensaje del sistema</p>
            <button class="modal-button" onclick="closeModal()">Continuar</button>
        </div>
    </div>

    <!-- Modal de Historial -->
    <div id="history-modal" class="history-modal">
        <div class="history-content">
            <div class="history-header">
                <h2 class="history-title" id="history-team-name">Historial de Operaciones</h2>
                <button class="btn-close-history" onclick="closeHistory()">‚úï Cerrar</button>
            </div>
            
            <div class="history-summary">
                <div class="summary-item">
                    <div class="summary-label">Balance Actual</div>
                    <div class="summary-value" id="history-balance">0 ptos</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Posici√≥n</div>
                    <div class="summary-value" id="history-position">0 ptos</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Operaciones</div>
                    <div class="summary-value" id="history-total">0</div>
                </div>
            </div>

            <div id="history-trades-container"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p class="copyright">¬© 2025 Eder Zu√±iga Mu√±oz</p>
        <p class="powered-by">Apoyado en GitHub Copilot</p>
    </footer>

    <script>
        let tradingData = null;
        let chart = null;
        let currentIndex = 0;
        let displayedCandles = [];
        const INITIAL_CANDLES = 5; // Mostrar las primeras 5 velas de Ideaci√≥n al inicio
        let currentEvent = null; // Evento actual que se muestra
        let pendingEvent = null; // Evento que afectar√° la siguiente iteraci√≥n

        // Temporizador
        let timerInterval = null;
        let timeRemaining = 30;
        const TIMER_DURATION = 30; // 30 segundos

        // Control de operaciones por iteraci√≥n
        let iterationOperations = {
            buys: [],
            sells: []
        };

        // Sistema de equipos
        const teams = {
            a: { name: 'Equipo A', balance: 100, position: 0, trades: [], pendingSell: [] },
            b: { name: 'Equipo B', balance: 100, position: 0, trades: [], pendingSell: [] },
            c: { name: 'Equipo C', balance: 100, position: 0, trades: [], pendingSell: [] }
        };

        // Guardar datos en localStorage
        function saveTeamsData() {
            localStorage.setItem('tradingTeams', JSON.stringify(teams));
            console.log('Datos guardados:', teams);
        }

        // Cargar datos desde localStorage
        function loadTeamsData() {
            const saved = localStorage.getItem('tradingTeams');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    console.log('Cargando datos desde localStorage:', data);
                    
                    // Validar que los datos tengan la estructura correcta
                    if (data.a && data.b && data.c) {
                        teams.a = data.a;
                        teams.b = data.b;
                        teams.c = data.c;
                        console.log('Datos cargados correctamente:', teams);
                        updateTeamsDisplay();
                    } else {
                        console.warn('Datos inv√°lidos en localStorage, usando valores por defecto');
                        initializeDefaultTeams();
                    }
                } catch (error) {
                    console.error('Error al cargar datos:', error);
                    initializeDefaultTeams();
                }
            } else {
                console.log('No hay datos guardados, usando valores por defecto');
                initializeDefaultTeams();
            }
        }

        // Inicializar equipos con valores por defecto
        function initializeDefaultTeams() {
            teams.a = { name: 'Equipo A', balance: 100, position: 0, trades: [], pendingSell: [] };
            teams.b = { name: 'Equipo B', balance: 100, position: 0, trades: [], pendingSell: [] };
            teams.c = { name: 'Equipo C', balance: 100, position: 0, trades: [], pendingSell: [] };
            updateTeamsDisplay();
        }

        // Actualizar displays de equipos
        function updateTeamsDisplay() {
            ['a', 'b', 'c'].forEach(team => {
                document.getElementById(`balance-${team}`).textContent = teams[team].balance.toFixed(2) + ' ptos';
                document.getElementById(`position-${team}`).textContent = teams[team].position.toFixed(2) + ' ptos';
                document.getElementById(`trades-${team}`).textContent = teams[team].trades.length;
            });
        }

        // Resetear datos de equipos
        function resetTeamsData() {
            if (!confirm('¬øEst√°s seguro de resetear todos los equipos y las iteraciones? Se perder√°n todos los datos.')) {
                return;
            }
            
            console.log('=== RESET: Limpiando localStorage y recargando p√°gina ===');
            
            // Limpiar localStorage completamente
            localStorage.removeItem('tradingTeams');
            
            // Recargar la p√°gina (equivalente a F5)
            location.reload();
        }

        // Funciones del temporizador
        function startTimer() {
            stopTimer(); // Detener cualquier temporizador anterior
            timeRemaining = TIMER_DURATION;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    stopTimer();
                    // Opcional: avanzar autom√°ticamente a la siguiente iteraci√≥n
                    // nextIteration();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timer-display');
            display.textContent = timeRemaining;
            
            // Cambiar color seg√∫n el tiempo restante
            display.classList.remove('warning', 'danger');
            if (timeRemaining <= 5) {
                display.classList.add('danger');
            } else if (timeRemaining <= 10) {
                display.classList.add('warning');
            }
        }

        // Registrar operaci√≥n de compra en la iteraci√≥n actual
        function registerBuyOperation(teamId, amount) {
            iterationOperations.buys.push({ teamId, amount });
        }

        // Registrar operaci√≥n de venta en la iteraci√≥n actual
        function registerSellOperation(teamId, amount) {
            iterationOperations.sells.push({ teamId, amount });
        }

        // Calcular impacto en el mercado por las operaciones
        function calculateMarketImpact(basePrice) {
            let impactMultiplier = 1.0;
            
            // Contar equipos √∫nicos que compraron y vendieron
            const uniqueBuyers = new Set(iterationOperations.buys.map(op => op.teamId)).size;
            const uniqueSellers = new Set(iterationOperations.sells.map(op => op.teamId)).size;
            
            // Calcular totales invertidos
            const totalBuyAmount = iterationOperations.buys.reduce((sum, op) => sum + op.amount, 0);
            const totalSellAmount = iterationOperations.sells.reduce((sum, op) => sum + op.amount, 0);
            
            // COMPRAS - Aumentan el precio
            if (uniqueBuyers === 3) {
                // Si los 3 equipos compraron: +30%
                impactMultiplier += 0.30;
                
                // Si adem√°s suman m√°s de 50 puntos: +20% adicional
                if (totalBuyAmount > 50) {
                    impactMultiplier += 0.20;
                }
            }
            
            // VENTAS - Disminuyen el precio
            if (uniqueSellers === 3) {
                // Si los 3 equipos vendieron: -30%
                impactMultiplier -= 0.30;
                
                // Si adem√°s suman m√°s de 50 puntos: -20% adicional
                if (totalSellAmount > 50) {
                    impactMultiplier -= 0.20;
                }
            }
            
            // Aplicar el impacto al precio base
            return basePrice * impactMultiplier;
        }

        // Limpiar operaciones de la iteraci√≥n
        function clearIterationOperations() {
            iterationOperations = {
                buys: [],
                sells: []
            };
        }

        // Realizar compra para un equipo (llamado desde el bot√≥n Comprar)
        function buyForTeam(teamId) {
            if (currentIndex === 0) {
                alert('Debes avanzar al menos una iteraci√≥n antes de comprar');
                return;
            }

            // Bloquear compras durante la etapa de Ideaci√≥n (iteraciones 1-5)
            if (currentIndex <= 5) {
                alert('‚ö†Ô∏è No puedes invertir durante la etapa de Ideaci√≥n. Espera a la iteraci√≥n 6 (Planificaci√≥n)');
                return;
            }

            const amount = parseFloat(document.getElementById(`amount-${teamId}`).value) || 0;
            
            if (amount <= 0) {
                alert('Ingresa una cantidad v√°lida');
                return;
            }

            const team = teams[teamId];
            const currentCandle = tradingData.candles[currentIndex - 1];
            const spread = calculateSpread(currentCandle.close);
            
            if (amount > team.balance) {
                alert(`${team.name}: Fondos insuficientes. Balance: ${team.balance.toFixed(0)} ptos`);
                return;
            }

            // Registrar la compra pendiente de venta
            const tradeId = Date.now() + Math.random();
            team.pendingSell.push({
                id: tradeId,
                iteration: currentIndex,
                buyPrice: spread.buy, // Este es el precio que se muestra
                units: amount / spread.buy,
                invested: amount,
                sold: false
            });

            team.balance -= amount;
            team.position += amount / spread.buy;
            team.trades.push({
                id: tradeId,
                iteration: currentIndex,
                action: 'buy',
                amount: amount,
                price: spread.buy,
                units: amount / spread.buy,
                balance: team.balance
            });

            // Limpiar formulario
            document.getElementById(`amount-${teamId}`).value = '';
            updateTeamsDisplay();
            saveTeamsData();
            
            // Registrar la operaci√≥n de compra para impacto en el mercado
            registerBuyOperation(teamId, amount);
            
            showStatusMessage(`${team.name} compr√≥ ${(amount / spread.buy).toFixed(2)} unidades por ${amount} ptos`, 'success');
        }

        // Vender una operaci√≥n espec√≠fica desde el historial
        function sellTrade(teamId, tradeId) {
            if (currentIndex === 0) {
                alert('No puedes vender sin avanzar iteraciones');
                return;
            }

            const team = teams[teamId];
            const pendingTrade = team.pendingSell.find(t => t.id === tradeId);
            
            if (!pendingTrade || pendingTrade.sold) {
                alert('Esta operaci√≥n ya fue vendida');
                return;
            }

            // Obtener precio actual de la gr√°fica (con impacto aplicado)
            const currentDisplayedClose = displayedCandles[displayedCandles.length - 1].c;
            const spread = calculateSpread(currentDisplayedClose);
            
            // Calcular ganancia/p√©rdida
            const sellAmount = pendingTrade.units * spread.sell;
            const profit = sellAmount - pendingTrade.invested;
            
            // Actualizar el equipo
            team.balance += sellAmount;
            team.position -= pendingTrade.units;
            pendingTrade.sold = true;
            pendingTrade.sellIteration = currentIndex;
            pendingTrade.sellPrice = spread.sell; // Este es el precio que se muestra
            pendingTrade.profit = profit;
            
            // Registrar la venta en el historial
            team.trades.push({
                id: Date.now() + Math.random(),
                iteration: currentIndex,
                action: 'sell',
                amount: sellAmount,
                price: spread.sell,
                units: pendingTrade.units,
                balance: team.balance,
                profit: profit,
                linkedBuyId: tradeId
            });

            updateTeamsDisplay();
            saveTeamsData();
            
            // Registrar la operaci√≥n de venta para impacto en el mercado
            registerSellOperation(teamId, sellAmount);
            
            // Recargar historial si est√° abierto
            showHistory(teamId);
            
            const profitText = profit >= 0 ? `+${profit.toFixed(2)}` : profit.toFixed(2);
            showStatusMessage(`${team.name} vendi√≥ por ${sellAmount.toFixed(2)} ptos (${profitText} ptos)`, profit >= 0 ? 'success' : 'error');
        }

        // Vender todas las posiciones abiertas
        function sellAllTrades(teamId) {
            const team = teams[teamId];
            const openTrades = team.pendingSell.filter(t => !t.sold);
            
            if (openTrades.length === 0) {
                alert('No hay posiciones abiertas para vender');
                return;
            }

            if (!confirm(`¬øVender todas las ${openTrades.length} posiciones abiertas?`)) {
                return;
            }

            openTrades.forEach(trade => {
                sellTrade(teamId, trade.id);
            });
        }

        // Procesar operaci√≥n de equipo (ya no se usa, se mantiene por compatibilidad)
        function processTeamTrade(teamId, currentPrice) {
            // Esta funci√≥n ya no hace nada, las compras se hacen con el bot√≥n
            return { success: true, message: '' };
        }

        // Exportar datos a JSON
        function exportTeamsData() {
            const dataStr = JSON.stringify(teams, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'trading-teams-data.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Formatear precio
        function formatPrice(price) {
            return price.toFixed(2) + ' ptos';
        }

        // Calcular spread
        function calculateSpread(price) {
            const spread = (price * tradingData.spreadPercent) / 100;
            return {
                buy: price + (spread / 2),  // Precio de compra (ASK)
                sell: price - (spread / 2)  // Precio de venta (BID)
            };
        }

        // Actualizar informaci√≥n de precios
        function updatePriceInfo(candle) {
            document.getElementById('price-open').textContent = formatPrice(candle.open);
            document.getElementById('price-high').textContent = formatPrice(candle.high);
            document.getElementById('price-low').textContent = formatPrice(candle.low);
            document.getElementById('price-close').textContent = formatPrice(candle.close);
            
            // Calcular y mostrar precios de compra/venta basados en el cierre
            const spread = calculateSpread(candle.close);
            document.getElementById('price-buy').textContent = formatPrice(spread.buy);
            document.getElementById('price-sell').textContent = formatPrice(spread.sell);
        }

        // Actualizar informaci√≥n de etapa y evento
        function updateStageEventInfo(iteration) {
            const stage = getCurrentStage(iteration);
            const stageEventContainer = document.getElementById('stage-event-info');
            
            if (!stage) {
                stageEventContainer.style.display = 'none';
                return;
            }

            stageEventContainer.style.display = 'grid';
            
            // Actualizar etapa
            document.getElementById('current-stage').textContent = stage.name;
            
            // Actualizar evento si existe
            if (currentEvent) {
                const eventBox = document.getElementById('event-box');
                eventBox.className = `event-box ${currentEvent.type}`;
                
                document.getElementById('event-icon').textContent = currentEvent.icon;
                document.getElementById('event-name').textContent = currentEvent.name;
                document.getElementById('event-desc').textContent = currentEvent.desc || '';
                
                const impactElement = document.getElementById('event-impact');
                const impactText = currentEvent.impact > 0 ? `+${currentEvent.impact}` : currentEvent.impact;
                impactElement.textContent = `Impacto pr√≥xima iteraci√≥n: ${impactText} puntos`;
                impactElement.className = `event-impact ${currentEvent.type}`;
            }
        }

        // Mostrar mensaje de estado
        function showStatusMessage(message, type = 'info', duration = 3000) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, duration);
        }

        // Mostrar modal
        function showModal(iteration) {
            const message = tradingData.messages[iteration.toString()];
            if (!message) return;

            const modal = document.getElementById('modal-overlay');
            const modalIcon = document.getElementById('modal-icon');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');

            // Extraer emoji del mensaje
            const emojiMatch = message.match(/^([\u{1F300}-\u{1F9FF}])/u);
            const emoji = emojiMatch ? emojiMatch[1] : 'üí°';
            const textMessage = message.replace(/^[\u{1F300}-\u{1F9FF}]\s*/u, '');

            modalIcon.textContent = emoji;
            modalTitle.textContent = `Iteraci√≥n ${iteration}`;
            modalMessage.textContent = textMessage;

            modal.classList.add('show');
        }

        // Cerrar modal
        function closeModal() {
            const modal = document.getElementById('modal-overlay');
            modal.classList.remove('show');
        }

        // Mostrar podio de ganadores
        function showPodium() {
            // Calcular el valor total de cada equipo (balance + posici√≥n actual)
            const currentPrice = displayedCandles.length > 0 ? displayedCandles[displayedCandles.length - 1].c : 100;
            
            const teamsRanking = [
                {
                    id: 'a',
                    name: 'Equipo A',
                    icon: 'üî¥',
                    balance: teams.a.balance,
                    position: teams.a.position,
                    total: teams.a.balance + (teams.a.position * currentPrice)
                },
                {
                    id: 'b',
                    name: 'Equipo B',
                    icon: 'üîµ',
                    balance: teams.b.balance,
                    position: teams.b.position,
                    total: teams.b.balance + (teams.b.position * currentPrice)
                },
                {
                    id: 'c',
                    name: 'Equipo C',
                    icon: 'üü¢',
                    balance: teams.c.balance,
                    position: teams.c.position,
                    total: teams.c.balance + (teams.c.position * currentPrice)
                }
            ];

            // Ordenar por total descendente
            teamsRanking.sort((a, b) => b.total - a.total);

            const modal = document.getElementById('modal-overlay');
            const modalIcon = document.getElementById('modal-icon');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');

            modalIcon.textContent = 'üèÜ';
            modalTitle.textContent = '¬°Proyecto Finalizado!';
            
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            const positions = ['first', 'second', 'third'];
            
            let podiumHTML = '<div class="podium-container">';
            
            teamsRanking.forEach((team, index) => {
                podiumHTML += `
                    <div class="podium-place ${positions[index]}">
                        <div class="podium-medal">${medals[index]}</div>
                        <div class="podium-block">
                            <div class="podium-team-name">${team.icon} ${team.name}</div>
                            <div class="podium-balance">${team.total.toFixed(2)} pts</div>
                            <div class="podium-position">${index + 1}¬∞</div>
                        </div>
                    </div>
                `;
            });
            
            podiumHTML += '</div>';
            podiumHTML += `<p style="margin-top: 20px; color: #666;">Balance final incluye efectivo + valor de posici√≥n</p>`;
            
            modalMessage.innerHTML = podiumHTML;
            modal.classList.add('show');
        }

        // Mostrar historial de equipo
        function showHistory(teamId) {
            const team = teams[teamId];
            const modal = document.getElementById('history-modal');
            
            // Obtener precio actual de la gr√°fica (con impacto aplicado)
            const currentDisplayedClose = displayedCandles.length > 0 ? displayedCandles[displayedCandles.length - 1].c : null;
            const currentSpread = currentDisplayedClose ? calculateSpread(currentDisplayedClose) : null;
            
            // Actualizar t√≠tulo y resumen
            const teamNames = { a: 'üî¥ Equipo A', b: 'üîµ Equipo B', c: 'üü¢ Equipo C' };
            document.getElementById('history-team-name').textContent = `${teamNames[teamId]} - Historial de Operaciones`;
            document.getElementById('history-balance').textContent = team.balance.toFixed(2) + ' ptos';
            document.getElementById('history-position').textContent = team.position.toFixed(2) + ' unidades';
            document.getElementById('history-total').textContent = team.trades.length;
            
            // Generar tabla de operaciones
            const container = document.getElementById('history-trades-container');
            
            if (team.pendingSell.length === 0) {
                container.innerHTML = '<div class="no-trades">No hay operaciones registradas</div>';
            } else {
                let tableHTML = `
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Iter.</th>
                                <th>Precio Compra</th>
                                <th>Invertido</th>
                                <th>Unidades</th>
                                <th>Precio Venta</th>
                                <th>Valor Venta</th>
                                <th>Ganancia</th>
                                <th>Estado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                team.pendingSell.forEach(trade => {
                    const rowClass = trade.sold ? 'trade-sold' : '';
                    let statusText = '';
                    let actionButton = '';
                    let sellPriceText = '-';
                    let sellValueText = '-';
                    let profitText = '-';
                    
                    if (trade.sold) {
                        // Operaci√≥n cerrada
                        const profitDisplay = trade.profit >= 0 ? `+${trade.profit.toFixed(2)}` : trade.profit.toFixed(2);
                        const profitClass = trade.profit >= 0 ? 'trade-buy' : 'trade-sell';
                        statusText = `<span class="${profitClass}">Vendido<br>#${trade.sellIteration}</span>`;
                        actionButton = '<button class="btn-sell-trade" disabled>Vendido</button>';
                        sellPriceText = `${trade.sellPrice.toFixed(2)} ptos`;
                        sellValueText = `${(trade.units * trade.sellPrice).toFixed(2)} ptos`;
                        profitText = `<span class="${profitClass}">${profitDisplay} ptos</span>`;
                    } else {
                        // Operaci√≥n abierta - calcular valor actual
                        if (currentSpread) {
                            const currentSellValue = trade.units * currentSpread.sell;
                            const currentProfit = currentSellValue - trade.invested;
                            const profitClass = currentProfit >= 0 ? 'trade-buy' : 'trade-sell';
                            const profitDisplay = currentProfit >= 0 ? `+${currentProfit.toFixed(2)}` : currentProfit.toFixed(2);
                            
                            sellPriceText = `<strong>${currentSpread.sell.toFixed(2)} ptos</strong>`;
                            sellValueText = `<strong>${currentSellValue.toFixed(2)} ptos</strong>`;
                            profitText = `<strong><span class="${profitClass}">${profitDisplay} ptos</span></strong>`;
                        }
                        statusText = '<span class="trade-buy">Abierta</span>';
                        actionButton = `<button class="btn-sell-trade" onclick="sellTrade('${teamId}', ${trade.id})">üî¥ Vender</button>`;
                    }
                    
                    tableHTML += `
                        <tr class="${rowClass}">
                            <td><strong>#${trade.iteration}</strong></td>
                            <td>${trade.buyPrice.toFixed(2)} ptos</td>
                            <td>${trade.invested.toFixed(2)} ptos</td>
                            <td>${trade.units.toFixed(2)}</td>
                            <td>${sellPriceText}</td>
                            <td>${sellValueText}</td>
                            <td>${profitText}</td>
                            <td>${statusText}</td>
                            <td>${actionButton}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                // Agregar bot√≥n "Vender Todo" con valor total
                const openTrades = team.pendingSell.filter(t => !t.sold);
                if (openTrades.length > 0 && currentSpread) {
                    let totalValue = 0;
                    let totalInvested = 0;
                    openTrades.forEach(t => {
                        totalValue += t.units * currentSpread.sell;
                        totalInvested += t.invested;
                    });
                    const totalProfit = totalValue - totalInvested;
                    const profitDisplay = totalProfit >= 0 ? `+${totalProfit.toFixed(2)}` : totalProfit.toFixed(2);
                    
                    tableHTML += `<button class="btn-sell-all" onclick="sellAllTrades('${teamId}')">üí∞ Vender Todo (${openTrades.length} posiciones) - ${totalValue.toFixed(2)} ptos (${profitDisplay})</button>`;
                }
                
                container.innerHTML = tableHTML;
            }
            
            modal.classList.add('show');
        }

        // Cerrar historial
        function closeHistory() {
            const modal = document.getElementById('history-modal');
            modal.classList.remove('show');
        }

        // Inicializar gr√°fico
        function initChart() {
            const ctx = document.getElementById('chart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: tradingData.instrument,
                        data: displayedCandles,
                        borderColor: 'rgba(0, 0, 0, 0.8)',
                        color: {
                            up: '#10b981',      // Verde para velas alcistas
                            down: '#ef4444',    // Rojo para velas bajistas
                            unchanged: '#6b7280' // Gris para sin cambio
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `Apertura: ${formatPrice(point.o)}`,
                                        `M√°ximo: ${formatPrice(point.h)}`,
                                        `M√≠nimo: ${formatPrice(point.l)}`,
                                        `Cierre: ${formatPrice(point.c)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0) + ' ptos';
                                },
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // Datos embebidos (alternativa a cargar JSON externo para evitar problemas CORS)
        const DATA = {
            "instrument": "Proyecto Software",
            "spreadPercent": 2, // Spread del 2%
            "candles": [
                // ETAPA 0: Ideaci√≥n (iter 1-5) - Solo eventos positivos, progreso a 75 pts
                { "timestamp": "2025-10-27", "open": 20, "high": 32, "low": 18, "close": 30 },
                { "timestamp": "2025-10-28", "open": 30, "high": 42, "low": 28, "close": 40 },
                { "timestamp": "2025-10-29", "open": 40, "high": 54, "low": 38, "close": 50 },
                { "timestamp": "2025-10-30", "open": 50, "high": 64, "low": 48, "close": 60 },
                { "timestamp": "2025-10-31", "open": 60, "high": 78, "low": 58, "close": 75 },
                
                // ETAPA 1: Planificaci√≥n/An√°lisis (iter 6-12) - VALLE 1 - Ca√≠da pronunciada
                { "timestamp": "2025-11-01", "open": 75, "high": 77, "low": 70, "close": 72 },
                { "timestamp": "2025-11-02", "open": 72, "high": 74, "low": 65, "close": 67 },
                { "timestamp": "2025-11-03", "open": 67, "high": 69, "low": 58, "close": 60 },
                { "timestamp": "2025-11-04", "open": 60, "high": 63, "low": 52, "close": 55 },
                { "timestamp": "2025-11-05", "open": 55, "high": 58, "low": 48, "close": 50 },
                { "timestamp": "2025-11-06", "open": 50, "high": 53, "low": 45, "close": 48 },  // M√çNIMO VALLE 1
                { "timestamp": "2025-11-07", "open": 48, "high": 55, "low": 47, "close": 52 },  // Inicio recuperaci√≥n
                
                // ETAPA 2: Dise√±o (iter 13-19) - PICO 1 - Subida fuerte
                { "timestamp": "2025-11-08", "open": 52, "high": 62, "low": 51, "close": 60 },
                { "timestamp": "2025-11-09", "open": 60, "high": 72, "low": 59, "close": 70 },
                { "timestamp": "2025-11-10", "open": 70, "high": 82, "low": 69, "close": 80 },
                { "timestamp": "2025-11-11", "open": 80, "high": 92, "low": 79, "close": 90 },
                { "timestamp": "2025-11-12", "open": 90, "high": 100, "low": 89, "close": 98 },
                { "timestamp": "2025-11-13", "open": 98, "high": 108, "low": 97, "close": 105 },  // M√ÅXIMO PICO 1
                { "timestamp": "2025-11-14", "open": 105, "high": 106, "low": 98, "close": 100 },  // Inicio ca√≠da
                
                // ETAPA 3: Desarrollo/Codificaci√≥n (iter 20-27) - VALLE 2 y recuperaci√≥n
                { "timestamp": "2025-11-15", "open": 100, "high": 102, "low": 92, "close": 94 },
                { "timestamp": "2025-11-16", "open": 94, "high": 95, "low": 85, "close": 87 },
                { "timestamp": "2025-11-17", "open": 87, "high": 88, "low": 78, "close": 80 },
                { "timestamp": "2025-11-18", "open": 80, "high": 82, "low": 68, "close": 70 },  // M√çNIMO VALLE 2
                { "timestamp": "2025-11-19", "open": 70, "high": 78, "low": 69, "close": 75 },  // Inicio recuperaci√≥n fuerte
                { "timestamp": "2025-11-20", "open": 75, "high": 86, "low": 74, "close": 84 },
                { "timestamp": "2025-11-21", "open": 84, "high": 95, "low": 83, "close": 93 },
                { "timestamp": "2025-11-22", "open": 93, "high": 103, "low": 92, "close": 101 },
                
                // ETAPA 4: Pruebas/Implementaci√≥n (iter 28-35) - PICO 2 y descenso final
                { "timestamp": "2025-11-23", "open": 101, "high": 112, "low": 100, "close": 110 },
                { "timestamp": "2025-11-24", "open": 110, "high": 120, "low": 109, "close": 118 },
                { "timestamp": "2025-11-25", "open": 118, "high": 128, "low": 117, "close": 125 },  // M√ÅXIMO PICO 2
                { "timestamp": "2025-11-26", "open": 125, "high": 126, "low": 118, "close": 120 },
                { "timestamp": "2025-11-27", "open": 120, "high": 122, "low": 112, "close": 114 },
                { "timestamp": "2025-11-28", "open": 114, "high": 115, "low": 105, "close": 107 },
                { "timestamp": "2025-11-29", "open": 107, "high": 109, "low": 98, "close": 100 },
                { "timestamp": "2025-11-30", "open": 100, "high": 102, "low": 92, "close": 95 }  // Cierre final
            ],
            "stages": {
                "0": { "name": "üí° Ideaci√≥n", "range": [1, 5], "color": "#ec4899" },
                "1": { "name": "üìã Planificaci√≥n/An√°lisis", "range": [6, 12], "color": "#3b82f6" },
                "2": { "name": "üé® Dise√±o", "range": [13, 19], "color": "#8b5cf6" },
                "3": { "name": "üíª Desarrollo/Codificaci√≥n", "range": [20, 27], "color": "#10b981" },
                "4": { "name": "üß™ Pruebas/Implementaci√≥n", "range": [28, 35], "color": "#f59e0b" }
            },
            "events": {
                "ideation": {
                    "positive": [
                        { "name": "Sponsors entusiasmados con la idea", "desc": "Los Sponsors dijeron 'esto es innovador' sin iron√≠a", "impact": 8, "icon": "üí°" },
                        { "name": "Product Owner define visi√≥n clara", "desc": "El PO describi√≥ la visi√≥n en 2 minutos. Record mundial", "impact": 10, "icon": "üéØ" },
                        { "name": "Stakeholders validan necesidad", "desc": "Los Stakeholders confirmaron que s√≠ necesitan esto", "impact": 9, "icon": "‚úÖ" },
                        { "name": "Team Members proponen innovaci√≥n", "desc": "El equipo sugiri√≥ ideas que realmente son viables", "impact": 11, "icon": "üöÄ" },
                        { "name": "Scrum Master arma equipo ideal", "desc": "El SM reuni√≥ un dream team que realmente existe", "impact": 10, "icon": "üë•" }
                    ]
                },
                "planning": {
                    "positive": [
                        { "name": "Product Owner clarifica visi√≥n", "desc": "El PO explic√≥ la visi√≥n del producto sin usar palabras de moda", "impact": 8, "icon": "ü§ù" },
                        { "name": "Stakeholders aprueban backlog", "desc": "Los Stakeholders dijeron 's√≠' sin pedir 'solo una cosita m√°s'", "impact": 10, "icon": "üìù" },
                        { "name": "Scrum Master facilita efectivamente", "desc": "El SM removi√≥ impedimentos antes de que alguien se quejara", "impact": 12, "icon": "üë•" },
                        { "name": "Sponsors liberan presupuesto", "desc": "Los Sponsors aprobaron la inversi√≥n sin necesitar 5 reuniones", "impact": 9, "icon": "üí∞" },
                        { "name": "Team Member propone stack ideal", "desc": "Un dev sugiri√≥ tecnolog√≠as que realmente tienen sentido", "impact": 11, "icon": "‚öôÔ∏è" }
                    ],
                    "negative": [
                        { "name": "Product Owner cambia prioridades", "desc": "El PO cambi√≥ todo el backlog porque 'se le ocurri√≥'", "impact": -10, "icon": "‚ùì" },
                        { "name": "Stakeholders ausentes", "desc": "Stakeholders desaparecieron como ninja despu√©s del kickoff", "impact": -8, "icon": "üòû" },
                        { "name": "Sponsors recortan presupuesto", "desc": "Sponsors quieren Lamborghini con presupuesto de bicicleta", "impact": -12, "icon": "üí∏" },
                        { "name": "Team Members sin expertise", "desc": "El equipo nunca toc√≥ esta tecnolog√≠a (ni google√≥)", "impact": -9, "icon": "üÜï" },
                        { "name": "Scrum Master impone deadlines irreales", "desc": "El SM prometi√≥ entrega para ayer... literalmente", "impact": -11, "icon": "‚è∞" }
                    ],
                    "neutral": [
                        { "name": "Reuni√≥n de Planning extensa", "desc": "La reuni√≥n dur√≥ 4 horas pero al menos hubo caf√©", "impact": 0, "icon": "‚òï" },
                        { "name": "Product Owner pide aclaraciones", "desc": "El PO hace preguntas obvias pero... bueno, es su trabajo", "impact": 0, "icon": "ü§î" },
                        { "name": "Stakeholders piden m√°s demos", "desc": "Quieren ver demos cada semana. M√°s reuniones, qu√© emoci√≥n", "impact": 0, "icon": "üì∫" },
                        { "name": "Team Members debaten arquitectura", "desc": "Los devs discuten tabs vs espacios... otra vez", "impact": 0, "icon": "üí¨" },
                        { "name": "Scrum Master programa retrospectiva", "desc": "Una retro m√°s donde diremos 'mejorar comunicaci√≥n'", "impact": 0, "icon": "üìÖ" }
                    ]
                },
                "design": {
                    "positive": [
                        { "name": "Product Owner aprueba wireframes", "desc": "Al PO le gustaron los dise√±os sin pedir 'm√°s color'", "impact": 10, "icon": "üèóÔ∏è" },
                        { "name": "Stakeholders validan mockups", "desc": "Los Stakeholders aprobaron el dise√±o a la primera. ¬øSue√±o?", "impact": 9, "icon": "‚úÖ" },
                        { "name": "Team Members aplican patrones", "desc": "Los devs usan patrones de dise√±o como si supieran lo que hacen", "impact": 11, "icon": "üìê" },
                        { "name": "Sponsors aprueban extra para UX", "desc": "Los Sponsors invirtieron en UX. ¬øCu√°l es el truco?", "impact": 8, "icon": "üéØ" },
                        { "name": "Scrum Master negocia m√°s tiempo", "desc": "El SM consigui√≥ m√°s tiempo para dise√±o. ¬°H√©roe!", "impact": 10, "icon": "üóÑÔ∏è" }
                    ],
                    "negative": [
                        { "name": "Product Owner rechaza dise√±o", "desc": "El PO dice 'no es lo que imagin√©' (nunca lo sabremos)", "impact": -10, "icon": "üß±" },
                        { "name": "Stakeholders exigen cambios", "desc": "Stakeholders: 'Cambien todo, pero que se vea igual'", "impact": -12, "icon": "‚ùå" },
                        { "name": "Team Members sin est√°ndares", "desc": "Cada dev dise√±a a su manera. Caos visual", "impact": -8, "icon": "üîÄ" },
                        { "name": "Sponsors cuestionan inversi√≥n", "desc": "Sponsors preguntan: '¬øPara qu√© UX? Que funcione y ya'", "impact": -11, "icon": "ÔøΩ" },
                        { "name": "Scrum Master presiona entregas", "desc": "El SM quiere dise√±o listo 'para ayer'. T√≠pico", "impact": -9, "icon": "‚ö†Ô∏è" }
                    ],
                    "neutral": [
                        { "name": "Product Owner revisa prototipos", "desc": "El PO mira los prototipos y dice 'interesante...'", "impact": 0, "icon": "üëÄ" },
                        { "name": "Stakeholders solicitan m√°s detalles", "desc": "Piden ver cada pixel antes de aprobar. Perfeccionistas", "impact": 0, "icon": "ÔøΩ" },
                        { "name": "Team Members debaten colores", "desc": "30 minutos discutiendo si azul #1E40AF o #1E3A8A", "impact": 0, "icon": "üé®" },
                        { "name": "Scrum Master organiza design review", "desc": "Otra reuni√≥n para revisar lo que ya revisamos", "impact": 0, "icon": "üñºÔ∏è" },
                        { "name": "Sponsors piden reportes de avance", "desc": "Quieren dashboard del dashboard del dashboard", "impact": 0, "icon": "üìä" }
                    ]
                },
                "development": {
                    "positive": [
                        { "name": "Team Members escriben c√≥digo limpio", "desc": "C√≥digo tan limpio que hasta Marie Kondo lo aprobar√≠a", "impact": 10, "icon": "‚ú®" },
                        { "name": "Scrum Master elimina impedimentos", "desc": "El SM resolvi√≥ problemas antes de que explotaran", "impact": 11, "icon": "üîÑ" },
                        { "name": "Product Owner disponible siempre", "desc": "El PO responde dudas en menos de 5 min. ¬øMagia?", "impact": 12, "icon": "üöÄ" },
                        { "name": "Sponsors proveen recursos extra", "desc": "Los Sponsors enviaron refuerzos. ¬°S√≠, refuerzos!", "impact": 9, "icon": "üêõ" },
                        { "name": "Stakeholders conf√≠an en el equipo", "desc": "Los Stakeholders dijeron 'ustedes saben'. Confianza level 100", "impact": 8, "icon": "üë¨" }
                    ],
                    "negative": [
                        { "name": "Team Members generan deuda t√©cnica", "desc": "'Lo arreglamos despu√©s' - Narrator: Nunca lo arreglaron", "impact": -11, "icon": "üìä" },
                        { "name": "Product Owner cambia requisitos", "desc": "El PO cambi√≥ todo en medio del sprint. ¬°Sorpresa!", "impact": -12, "icon": "üî¥" },
                        { "name": "Scrum Master permite scope creep", "desc": "El SM acepta 'solo una cosita m√°s' (x15 veces)", "impact": -10, "icon": "üçù" },
                        { "name": "Sponsors cortan recursos", "desc": "Sponsors se llevaron dos devs 'prestados'", "impact": -8, "icon": "ÔøΩ" },
                        { "name": "Stakeholders exigen demos constantes", "desc": "Quieren demo diaria. ¬øCu√°ndo codificamos?", "impact": -9, "icon": "üö´" }
                    ],
                    "neutral": [
                        { "name": "Team Members hacen code review", "desc": "Code review donde todos dicen 'LGTM' sin leer", "impact": 0, "icon": "üëì" },
                        { "name": "Scrum Master facilita daily", "desc": "Daily de 15 min que se convirti√≥ en 45 min", "impact": 0, "icon": "‚è±Ô∏è" },
                        { "name": "Product Owner actualiza backlog", "desc": "El PO reorganiz√≥ el backlog por 5ta vez esta semana", "impact": 0, "icon": "ÔøΩ" },
                        { "name": "Stakeholders visitan al equipo", "desc": "Stakeholders 'solo pasaban por aqu√≠ a saludar' (inspeccionar)", "impact": 0, "icon": "üëã" },
                        { "name": "Sponsors piden m√©tricas", "desc": "Quieren saber cu√°ntas l√≠neas de c√≥digo por hora", "impact": 0, "icon": "ÔøΩ" }
                    ]
                },
                "testing": {
                    "positive": [
                        { "name": "Team Members alcanzan 90% cobertura", "desc": "Tests verdes por todos lados. ¬øEst√°n funcionando?", "impact": 12, "icon": "‚úîÔ∏è" },
                        { "name": "Product Owner acepta el producto", "desc": "El PO dijo 'perfecto' sin pedir cambios. ¬°Milagro!", "impact": 10, "icon": "üìà" },
                        { "name": "Stakeholders satisfechos en demo", "desc": "Los Stakeholders aplaudieron en la demo. Hist√≥rico", "impact": 11, "icon": "üòä" },
                        { "name": "Scrum Master coordina deploy perfecto", "desc": "Deploy un viernes y nada se rompi√≥. ¬°Leyenda!", "impact": 9, "icon": "üéâ" },
                        { "name": "Sponsors celebran el √©xito", "desc": "Los Sponsors invitan cervezas. Best day ever", "impact": 8, "icon": "‚ö°" }
                    ],
                    "negative": [
                        { "name": "Team Members olvidan casos edge", "desc": "Tests no cubr√≠an el caso 'usuario hace locuras'", "impact": -12, "icon": "üí•" },
                        { "name": "Product Owner encuentra bugs cr√≠ticos", "desc": "El PO descubri√≥ que el bot√≥n principal no funciona", "impact": -11, "icon": "ÔøΩ" },
                        { "name": "Stakeholders rechazan entregable", "desc": "Stakeholders: 'No es lo que esper√°bamos' (s√≠ lo es)", "impact": -10, "icon": "ÔøΩ" },
                        { "name": "Scrum Master autoriza rollback", "desc": "El SM dice: 'Revertir TODO'. P√°nico general", "impact": -9, "icon": "‚èÆÔ∏è" },
                        { "name": "Sponsors cuestionan ROI", "desc": "Sponsors: '¬øGastamos TODO ESO en esto?'", "impact": -8, "icon": "üê¢" }
                    ],
                    "neutral": [
                        { "name": "Team Members corrigen tests", "desc": "Arreglando tests que fallaban por razones misteriosas", "impact": 0, "icon": "ÔøΩ" },
                        { "name": "Product Owner solicita m√°s pruebas", "desc": "El PO quiere probar escenarios que nadie usar√°", "impact": 0, "icon": "üß™" },
                        { "name": "Stakeholders piden certificaciones", "desc": "Quieren documentos de tests para el archivo muerto", "impact": 0, "icon": "üìú" },
                        { "name": "Scrum Master programa retrospectiva", "desc": "Retro final: 'Estuvo bien, mejorar comunicaci√≥n'", "impact": 0, "icon": "üîÑ" },
                        { "name": "Sponsors revisan cumplimiento", "desc": "Sponsors verifican que se cumpli√≥ lo prometido", "impact": 0, "icon": "‚úÖ" }
                    ]
                }
            },
            "messages": {
                "5": "üí° Product Owner: 'La idea est√° clara. Los Sponsors est√°n emocionados. ¬°A planificar!'",
                "10": "üìã Scrum Master: 'Planificaci√≥n completa. El backlog tiene sentido... por ahora'",
                "15": "üé® Stakeholders: 'Dise√±os aprobados. Team Members listos para codificar'",
                "20": "üíª Product Owner: 'Desarrollo avanzando. Los Sponsors preguntan cada d√≠a'",
                "25": "üîß Scrum Master: 'C√≥digo funcionando. Sponsors nerviosos pero optimistas'",
                "30": "üß™ Team Members: 'Testing en progreso. Rezando que todo pase'",
                "35": "üèÜ Stakeholders: '¬°Proyecto completo! Los Sponsors est√°n... sorprendidos de que funcione'"
            }
        };

        // Determinar etapa actual basada en la iteraci√≥n
        function getCurrentStage(iteration) {
            for (const [key, stage] of Object.entries(DATA.stages)) {
                if (iteration >= stage.range[0] && iteration <= stage.range[1]) {
                    return { id: key, ...stage };
                }
            }
            return null;
        }

        // Seleccionar evento aleatorio seg√∫n la etapa
        function getRandomEvent(iteration) {
            const stage = getCurrentStage(iteration);
            if (!stage) return null;

            let eventCategory;
            switch(stage.id) {
                case "0": eventCategory = DATA.events.ideation; break;
                case "1": eventCategory = DATA.events.planning; break;
                case "2": eventCategory = DATA.events.design; break;
                case "3": eventCategory = DATA.events.development; break;
                case "4": eventCategory = DATA.events.testing; break;
                default: return null;
            }

            // ETAPA DE IDEACI√ìN: Solo eventos positivos
            if (stage.id === "0") {
                const events = eventCategory.positive;
                const randomEvent = events[Math.floor(Math.random() * events.length)];
                return {
                    ...randomEvent,
                    type: 'positive',
                    stage: stage.name
                };
            }

            // OTRAS ETAPAS: 33% positivo, 33% negativo, 33% neutral
            const randomValue = Math.random();
            let eventType, events;
            
            if (randomValue < 0.33) {
                eventType = 'positive';
                events = eventCategory.positive;
            } else if (randomValue < 0.66) {
                eventType = 'negative';
                events = eventCategory.negative;
            } else {
                eventType = 'neutral';
                events = eventCategory.neutral;
            }
            
            const randomEvent = events[Math.floor(Math.random() * events.length)];

            return {
                ...randomEvent,
                type: eventType,
                stage: stage.name
            };
        }

        // Cargar datos
        function loadData() {
            try {
                tradingData = DATA;
                
                // Inicializar con las primeras velas
                const initialCount = Math.min(INITIAL_CANDLES, tradingData.candles.length);
                for (let i = 0; i < initialCount; i++) {
                    const candle = tradingData.candles[i];
                    displayedCandles.push({
                        x: new Date(candle.timestamp).getTime(),
                        o: candle.open,
                        h: candle.high,
                        l: candle.low,
                        c: candle.close
                    });
                }
                
                currentIndex = initialCount;
                
                // Actualizar UI
                document.getElementById('current-iteration').textContent = currentIndex;
                document.getElementById('total-iterations').textContent = tradingData.candles.length;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chart-content').style.display = 'block';
                
                // Inicializar gr√°fico
                initChart();
                
                // Actualizar precios con la √∫ltima vela mostrada
                updatePriceInfo(tradingData.candles[currentIndex - 1]);
                
                // Habilitar bot√≥n
                document.getElementById('btn-next').disabled = false;
                
                showStatusMessage(`Datos cargados correctamente. Mostrando ${initialCount} velas iniciales.`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').textContent = 'Error al cargar los datos.';
                showStatusMessage('Error al cargar los datos', 'error');
            }
        }

        // Avanzar a la siguiente iteraci√≥n
        function nextIteration() {
            if (currentIndex >= tradingData.candles.length) {
                showStatusMessage('Has llegado al final de los datos', 'info');
                document.getElementById('btn-next').disabled = true;
                stopTimer();
                
                // Ofrecer exportar datos
                setTimeout(() => {
                    if (confirm('¬øDeseas exportar los datos de trading de los equipos?')) {
                        exportTeamsData();
                    }
                }, 500);
                return;
            }

            const candle = tradingData.candles[currentIndex];
            
            console.log(`\n=== ITERACI√ìN ${currentIndex + 1} ===`);
            console.log('Precio base de vela:', candle.close);
            
            // Aplicar impacto del evento PENDIENTE (del turno anterior) al precio base
            let eventAdjustedClose = candle.close;
            let eventAdjustedHigh = candle.high;
            let eventAdjustedLow = candle.low;
            let appliedEventMessage = '';
            
            if (pendingEvent) {
                const impact = pendingEvent.impact;
                eventAdjustedClose = candle.close + impact;
                console.log(`Evento aplicado: ${pendingEvent.name} (${impact > 0 ? '+' : ''}${impact})`);
                console.log(`Precio despu√©s del evento: ${eventAdjustedClose}`);
                
                // Ajustar high y low seg√∫n el impacto del evento
                if (impact > 0) {
                    // Evento positivo: el high debe ser al menos close + impact
                    eventAdjustedHigh = Math.max(candle.high, eventAdjustedClose);
                    eventAdjustedLow = candle.low; // El low no cambia con evento positivo
                } else if (impact < 0) {
                    // Evento negativo: el low debe ser al menos close + impact
                    eventAdjustedLow = Math.min(candle.low, eventAdjustedClose);
                    eventAdjustedHigh = candle.high; // El high no cambia con evento negativo
                }
                
                const impactSign = impact > 0 ? '+' : (impact < 0 ? '' : '');
                appliedEventMessage = `${pendingEvent.icon} ¬°Evento aplicado! "${pendingEvent.name}" (${impactSign}${impact} pts)`;
            } else {
                console.log('Sin evento pendiente');
            }
            
            // Generar NUEVO evento aleatorio que se mostrar√° ahora pero afectar√° la SIGUIENTE iteraci√≥n
            currentEvent = getRandomEvent(currentIndex + 1);
            pendingEvent = currentEvent; // Este evento afectar√° la pr√≥xima vela
            console.log(`Nuevo evento generado para pr√≥xima iteraci√≥n: ${currentEvent.name} (${currentEvent.impact > 0 ? '+' : ''}${currentEvent.impact})`);
            
            // Procesar operaciones de equipos CON el precio ajustado por el evento
            ['a', 'b', 'c'].forEach(teamId => {
                processTeamTrade(teamId, eventAdjustedClose);
            });
            
            // Calcular impacto del mercado basado en las operaciones de esta iteraci√≥n
            const impactedClose = calculateMarketImpact(eventAdjustedClose);
            
            if (impactedClose !== eventAdjustedClose) {
                const diff = impactedClose - eventAdjustedClose;
                const percentage = ((diff / eventAdjustedClose) * 100).toFixed(1);
                console.log(`Impacto del mercado: ${diff > 0 ? '+' : ''}${diff.toFixed(2)} (${percentage}%)`);
                console.log(`Precio final: ${impactedClose.toFixed(2)}`);
            } else {
                console.log('Sin impacto del mercado');
                console.log(`Precio final: ${impactedClose.toFixed(2)}`);
            }
            
            // Mostrar mensaje del evento aplicado
            if (appliedEventMessage) {
                let messageType = 'info'; // neutral
                if (pendingEvent && pendingEvent.impact > 0) messageType = 'success';
                if (pendingEvent && pendingEvent.impact < 0) messageType = 'error';
                showStatusMessage(appliedEventMessage, messageType, 5000); // 5 segundos para leerlo
            }
            
            // Mostrar mensaje si hubo impacto significativo del mercado
            if (impactedClose !== eventAdjustedClose) {
                const uniqueBuyers = new Set(iterationOperations.buys.map(op => op.teamId)).size;
                const uniqueSellers = new Set(iterationOperations.sells.map(op => op.teamId)).size;
                const totalBuyAmount = iterationOperations.buys.reduce((sum, op) => sum + op.amount, 0);
                const totalSellAmount = iterationOperations.sells.reduce((sum, op) => sum + op.amount, 0);
                
                let impactMessage = '';
                if (uniqueBuyers === 3) {
                    impactMessage = `üöÄ ¬°IMPACTO MERCADO! Los 3 equipos compraron`;
                    if (totalBuyAmount > 50) {
                        impactMessage += ` m√°s de 50 ptos (${totalBuyAmount.toFixed(0)} ptos). Precio +50%`;
                    } else {
                        impactMessage += `. Precio +30%`;
                    }
                }
                if (uniqueSellers === 3) {
                    impactMessage = `üìâ ¬°IMPACTO MERCADO! Los 3 equipos vendieron`;
                    if (totalSellAmount > 50) {
                        impactMessage += ` m√°s de 50 ptos (${totalSellAmount.toFixed(0)} ptos). Precio -50%`;
                    } else {
                        impactMessage += `. Precio -30%`;
                    }
                }
                if (impactMessage) {
                    setTimeout(() => showStatusMessage(impactMessage, 'info'), 500);
                }
            }
            
            // Obtener el precio de cierre de la vela anterior
            const previousClose = displayedCandles.length > 0 ? 
                displayedCandles[displayedCandles.length - 1].c : 
                candle.open;
            
            // Aplicar el precio con impacto a la vela, ajustando high y low correctamente
            const adjustedCandle = {
                ...candle,
                open: previousClose, // La apertura es el cierre anterior
                close: impactedClose,
                high: Math.max(eventAdjustedHigh, impactedClose, previousClose),
                low: Math.min(eventAdjustedLow, impactedClose, previousClose)
            };
            
            // Agregar nueva vela con el precio ajustado
            displayedCandles.push({
                x: new Date(adjustedCandle.timestamp).getTime(),
                o: adjustedCandle.open,
                h: adjustedCandle.high,
                l: adjustedCandle.low,
                c: adjustedCandle.close
            });

            currentIndex++;

            // Actualizar gr√°fico
            chart.data.datasets[0].data = [...displayedCandles];
            chart.update('active');

            // Actualizar precios con el precio ajustado
            updatePriceInfo(adjustedCandle);
            
            // Actualizar informaci√≥n de etapa y evento
            updateStageEventInfo(currentIndex);
            
            // Limpiar operaciones para la siguiente iteraci√≥n
            clearIterationOperations();

            // Actualizar contador
            document.getElementById('current-iteration').textContent = currentIndex;

            // Reiniciar temporizador
            startTimer();

            // Deshabilitar bot√≥n si llegamos al final
            if (currentIndex >= tradingData.candles.length) {
                document.getElementById('btn-next').disabled = true;
                showStatusMessage('¬°Proyecto finalizado! üéâ', 'success');
                stopTimer();
                
                // Mostrar podio de ganadores
                setTimeout(() => {
                    showPodium();
                }, 1000);
            } else {
                showStatusMessage(`Vela ${currentIndex} agregada`, 'success');
            }

            // Mostrar modal cada 5 iteraciones
            if (currentIndex % 5 === 0) {
                showModal(currentIndex);
            }
        }

        // Event listeners
        document.getElementById('btn-next').addEventListener('click', nextIteration);

        // Cargar datos al iniciar
        loadTeamsData();
        loadData();
    </script>
</body>
</html>


